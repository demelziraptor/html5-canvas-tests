<!DOCTYPE HTML>
<html>
  <head>
    <title>Test Page</title>
    <style>
      body {
        margin: 0px;
        padding: 0px;
      }
      canvas {
        border: 1px solid #9C9898;
      }
    </style>
    <script src="kinetic-v3.9.7.min.js"></script>
    <script src="canvas2image.js"></script>
    <script src="base64.js"></script>
    
    <script>

      var stage;
      var layer;
      var selected;
      var wasSelected;

      /*
       * Set up canvas stage and layer
       */
      function initCanvas(id) {
        stage = new Kinetic.Stage({
        container: id,
        width: 850,
        height: 500
        });
        layer = new Kinetic.Layer();
        stage.add(layer);
        stage.draw();
      }
      
      
      /*
       * Resize
       */
      function resize(group, activeAnchor) {
        var tl = group.get(".tl")[0];
        var tr = group.get(".tr")[0];
        var br = group.get(".br")[0];
        var bl = group.get(".bl")[0];
        var handle = group.get(".handle")[0];
        var ghost = group.get(".ghost")[0];
        var image = group.get(".image")[0];

        switch (activeAnchor.attrs.name) {
          case "tl":
            //bl.setPosition(tl.attrs.x, br.attrs.y);
            bl.attrs.x = tl.attrs.x;
            bl.attrs.y = br.attrs.y;
            tr.attrs.x = br.attrs.x;
            tr.attrs.y = tl.attrs.y;
            break;
          case "tr":
            br.attrs.x = tr.attrs.x;
            br.attrs.y = bl.attrs.y;
            tl.attrs.x = bl.attrs.x;
            tl.attrs.y = tr.attrs.y;
            break;
          case "bl":
            br.attrs.x = tr.attrs.x;
            br.attrs.y = bl.attrs.y;
            tl.attrs.x = bl.attrs.x;
            tl.attrs.y = tr.attrs.y;
            break;
          case "br":
            bl.attrs.x = tl.attrs.x;
            bl.attrs.y = br.attrs.y;
            tr.attrs.x = br.attrs.x;
            tr.attrs.y = tl.attrs.y;
            break;
          }
          
          handle.attrs.x = tr.attrs.x / 2;
          handle.attrs.y = tr.attrs.y - 20;
          ghost.attrs.x = handle.attrs.x;
          ghost.attrs.y = handle.attrs.y;
          
          image.attrs.x = tl.attrs.x;
          image.attrs.y = tl.attrs.y;
          image.attrs.width = tr.attrs.x - tl.attrs.x;
          image.attrs.height = bl.attrs.y - tl.attrs.y;
      }
      
      
      /*
       * Rotate
       */
      function rotate(group) {
        var c = group.getAbsolutePosition();
        var p0 = {x: c.x, y: c.y - 50};
        var p1 = stage.getUserPosition();
        
        var p0c = Math.sqrt(Math.pow(c.x-p0.x,2) + Math.pow(c.y-p0.y,2)); // p0->c (b)   
        var p1c = Math.sqrt(Math.pow(c.x-p1.x,2) + Math.pow(c.y-p1.y,2)); // p1->c (a)
        var p0p1 = Math.sqrt(Math.pow(p1.x-p0.x,2) + Math.pow(p1.y-p0.y,2)); // p0->p1 (c)
        
        var deg =  Math.acos((p1c*p1c+p0c*p0c-p0p1*p0p1)/(2*p1c*p0c));

        // fix for negative rotation
        if(p1.x < c.x) {
          deg = (360 * (Math.PI/180)) - deg;
        }
        group.setRotation(deg);
      }
      
      
      /*
       * Add an image plus anchors to the canvas using group
       */
      function initImage(img) {
        // Make a group for all the elements (img + anchors)
        var kimggroup = new Kinetic.Group({
          x: 300,
          y: 300,
          draggable: true,
          centerOffset: [img.width/2, img.height/2]
        });
        layer.add(kimggroup);
        stage.add(layer);

        // Make the img and add it to the group
        var kimg = new Kinetic.Image({
          x: 0,
          y: 0,
          image: img,
          width: img.width,
          height: img.height,
          name: "image"
        });
        kimggroup.add(kimg);

        // Add anchors for resizing and rotation
        addAnchor(kimggroup, 0, 0, "tl");
        addAnchor(kimggroup, img.width, 0, "tr");
        addAnchor(kimggroup, img.width, img.height, "br");
        addAnchor(kimggroup, 0, img.height, "bl");
        addAnchor(kimggroup, img.width / 2, -20, "handle");
        addAnchor(kimggroup, img.width / 2, -20,  "ghost");

        // On click make the image selected
        kimggroup.on("mousedown", function() {
          wasSelected = selected;
          selected = this;
          //updateSelected();
          this.moveToTop();
          //kimggroup.setRotation(Math.PI/16);
          stage.draw();
        });

        // Update cursor on mouseover
        kimg.on("mouseover", function() {
          document.body.style.cursor = "move";
        });

        kimg.on("mouseout", function() {
          document.body.style.cursor = "default";
        });

        // Draw the img
        //stage.add(layer);
        stage.draw();
      }
      
      
      /*
       * Create anchor and add to group
       */
      function addAnchor(group, x, y, name) {
        var config = {
          x: x,
          y: y,
          stroke: "#666", 
          fill: "#ddd", 
          strokeWidth: 2, 
          radius: 4, 
          name: name, 
          draggable: true
        }
        switch (name) {
          case "handle":
            config.draggable = false;
            var anchor = addRotateAnchor(group, config);
            break;
          case "ghost":
            config.stroke = "#993333";
            var anchor = addRotateGhostAnchor(group, config);
            break;
          default:
            var anchor = addResizeAnchor(group, config);
            break;
        }
        //anchor.hide();
        group.add(anchor);
      }
      
      /*
       * Set up resize anchor
       */
      function addResizeAnchor(group, config) {
        var anchor = new Kinetic.Circle(config);
        
        anchor.on("dragmove", function() {
          resize(group, this);
          layer.draw();
        });
        anchor.on("mousedown touchstart", function() {
          group.draggable(false);
          this.moveToTop();
        });
        anchor.on("dragend", function() {
          group.draggable(true);
          layer.draw();
        });
        
        anchor.on("mouseover", function() {
          var layer = this.getLayer();
          document.body.style.cursor = "pointer";
          this.setStrokeWidth(3);
          layer.draw();
        });
        anchor.on("mouseout", function() {
          var layer = this.getLayer();
          document.body.style.cursor = "default";
          this.setStrokeWidth(2);
          layer.draw();
        });
        return anchor;
      }
      
      /*
       * Set up rotation anchor
       */
      function addRotateAnchor(group, config) {
        var anchor = new Kinetic.Circle(config);
        
        anchor.on("mouseover", function() {
          var layer = this.getLayer();
          document.body.style.cursor = "pointer";
          this.setStrokeWidth(3);
          layer.draw();
        });
        anchor.on("mouseout", function() {
          var layer = this.getLayer();
          document.body.style.cursor = "default";
          this.setStrokeWidth(2);
          layer.draw();
        });
        return anchor;
      }
      
      /*
       * Set up rotation ghost anchor
       */
      function addRotateGhostAnchor(group, config) {
        var anchor = new Kinetic.Circle(config);
        
        anchor.on("dragmove", function() {
          rotate(group);
          layer.draw();
        });
        anchor.on("mousedown touchstart", function() {
          group.draggable(false);
          this.moveToTop();
        });
        anchor.on("dragend", function() {
          var handle = group.get(".handle")[0];
          this.attrs.x = handle.attrs.x;
          this.attrs.y = handle.attrs.y;
          group.draggable(true);
          layer.draw();
        });
        
        anchor.on("mouseover", function() {
          var layer = this.getLayer();
          document.body.style.cursor = "pointer";
          this.setStrokeWidth(3);
          layer.draw();
        });
        anchor.on("mouseout", function() {
          var layer = this.getLayer();
          document.body.style.cursor = "default";
          this.setStrokeWidth(2);
          layer.draw();
        });
        return anchor;
      }
      
      
      /*
       * Add clicked images to the canvas
       */
      function addGabby(name) {
        var img = document.getElementById(name);
        initImage(img); 
      }

      
      
      window.onload = function() {
        initCanvas("container");
      };

    </script>
  </head>
  <body onmousedown="return false;">
    <div id="right" style="float: right;">
      <img src="image.jpg" name="gabby" id="gabby" onClick="addGabby('gabby')" /><br /><br />
      <a href="#" name="downloadcanvas" id="downloadcanvas" onClick="downloadCanvas()">download</a><br /><br />
      <a href="#" name="clearcanvas" id="clearcanvas" onClick="clearCanvas()">clear</a>
    </div><!-- #right -->
    <div role="main">
      <div id="container">
      </div><!-- #container -->
    </div><!-- main -->
  </body>
</html>
